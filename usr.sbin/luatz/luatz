#!/usr/libexec/flua

require("dialog_wrap")
getopt = require("getopt")

--TODO:
--	add better description text
--	add CLDR support maybe
--	make UTC work

COUNTRY_FILENAME = "/usr/share/misc/iso3166"
ZONEINFO_FILENAME = "/usr/share/zoneinfo/zone1970.tab"

continent_order = {"Africa", "America", "Antarctica", "Asia", "Atlantic",
		   "Australia", "Europe", "Indian", "Pacific", "UTC"}

continents = {
	Asia 		= {countries = {}},
	America 	= {countries = {}},
	Europe 		= {countries = {}},
	Africa 		= {countries = {}},
	Antarctica 	= {countries = {}},
	Australia 	= {countries = {}},
	Atlantic 	= {countries = {}, ocean = true},
	Pacific 	= {countries = {}, ocean = true},
	Indian 		= {countries = {}, ocean = true},
	UTC 		= {countries = {}},
}

-- enum of the possible UI states
states = {
	PICK_CONTINENT		= 0,
	PICK_COUNTRY		= 1,
	PICK_TIMEZONE		= 2,
	CONFIRM_TIMEZONE	= 3,
}

-- Format :
-- countries[two_letter_country_code] = {
--	name = (full name of country),
--	tzs = array of {
--		name = (name of timezone),
--		comment = (comment for timezone)
--	}
-- }
countries = {}

local function pickContinentDialog(default_continent)
	local default_option = 0

	for i, continent in ipairs(continent_order) do
		if (continent == default_continent) then
			default_option = i - 1
		end
	end

	local retcode, cont = dialogMenu("Pick a continent",
	    "description", 0, 0, 10, 10, default_option,
	    continent_order,
	    {"", "(North and South)", "", "", "", "", "", "", "", ""})

	if (retcode == 0) then
		return retcode, cont:match("^%g*")
	else
		return retcode
	end
end

local function pickCountryDialog(continent, default_country)
	local width = 0
	local keys = {}
	local vals = {}
	local countries_in_cont = continents[continent].countries
	local height = #countries_in_cont + 8
	local title_text
	local default_option = 0

	if (continents[continent].ocean) then
		title_text = "Islands and groups in the " .. continent .. " Ocean"
	else
		title_text = "Countries in " .. continent
	end

	width = #title_text + 7

	for i, country_code in ipairs(countries_in_cont) do
		table.insert(keys, country_code)
		table.insert(vals, countries[country_code].name)
		width = math.max(width, #country_code + #countries[country_code].name + 10)

		if (country_code == default_country) then
			default_option = i-1
		end
	end
	
	local retcode, country_code = dialogMenu(title_text,
	    "select a country or region", height, width, height,
	    #countries_in_cont, default_option, keys, vals)
	return retcode, country_code
end

local function pickTimezoneDialog(country, default_timezone)
	local tzs = countries[country].tzs
	local default_option = 0

	local width = 0
	local height = #tzs + 8
	local keys = {}
	local vals = {}

	for i, tz in ipairs(tzs) do
		table.insert(keys, tz.name)
		table.insert(vals, tz.comment)
		width = math.max(width, #tz.name + #tz.comment + 10)

		if (tz.name == default_timezone) then
			default_option = i-1
		end
	end

	local retcode, tz_name = dialogMenu("Pick a Timezone",
	    "description", height, width, height, #tzs, default_option, keys, vals)

	return retcode, tz_name
end

local function confirmTimezoneDialog(timezone)
	local confirm = dialogYesNo("Confirm Timezone", "Is " .. timezone .. " correct? TODO: change to three-letter timezone code instead", 0, 0)
	return confirm
end

local function splitString(str, char)
	local split_list = {}
	local pattern = "[^" .. char .. "]+"

	for match in str:gmatch(pattern) do
		table.insert(split_list, match)
	end

	return split_list
end

-- Inserts a country code into a continent's array
-- of countries, sorted by the country's full name
local function insertCountry(country_code, continent)
	local country_list = continents[continent].countries

	for i, country in ipairs(country_list) do
		-- don't put in duplicates
		if (country == country_code) then
			return
		elseif (countries[country_code].name < countries[country].name) then
			table.insert(country_list, i, country_code)
			return
		end
	end

	-- list was empty, or this country comes last
	table.insert(country_list, country_code)
	return
end

local function getCountryCodes()
	
	for line in io.lines(COUNTRY_FILENAME) do
		if (not (line:sub(1,1) == "#")) then
			local split_list = splitString(line, "\t")
			local country_code = split_list[1]
			local country_name = split_list[4]

			countries[country_code] =
			    {name = country_name, tzs = {}}
		end
	end
end

local function getTimezoneCodes()

	for line in io.lines(ZONEINFO_FILENAME) do
		if (not (line:sub(1, 1) == "#")) then
			local split_list = splitString(line, "\t")

			local country_codes = split_list[1]
			local country_list = splitString(country_codes, ",")

			local tz_name = split_list[3]
			local tz_continent = tz_name:match("^[^/]*")

			-- This may be nil but that's okay
			local comment = split_list[4]

			local tz = {name = tz_name, comment = comment}

			for i, country_code in pairs(country_list) do
				--put the country in the continent
				insertCountry(country_code, tz_continent)

				--put the timezone in the country
				table.insert(countries[country_code].tzs, tz)
			end
		end
	end
end

local function main()
	local really_do_it = true
	local ch, optarg, optind

	local nonoptions = {}
	for ch, arg in getopt(arg, "C:nrs", nonoptions) do
		print(ch, arg)
		if (ch == "n") then
			really_do_it = false
		elseif (ch == "r") then
		elseif (ch == "s") then
		elseif (ch == "C") then
		else
			print("TODO WRITE ERROR MESSAGE")
			return
		end
	end

	-- Having a non-option means we should treat it
	-- as a timezone file/name. Use tzsetup for now
	-- to make it work.
	if (#nonoptions > 0) then
		if (#nonoptions ~= 1) then
			print("TODO WRITE ERROR MESSAGE")
		elseif (not really_do_it) then
			print(nonoptions[1])
		else
			os.execute("tzsetup " .. nonoptions[1])
		end
		return
	end

	initDialog()
	getCountryCodes()
	getTimezoneCodes()

	local retcode, continent, country, timezone
	local final_timezone

	-- The previous states of the menu are stored
	-- in this stack, so that if the user chooses
	-- to go back they will go to the right place.
	-- The 'current' state is always the top of
	-- the stack.
	local state_stack = {states.PICK_CONTINENT}

	while (true) do
		if (#state_stack == 0) then
			break
		end

		local state = state_stack[#state_stack]
		if (state == states.PICK_CONTINENT) then
			retcode, continent = pickContinentDialog(continent)
			if (retcode == 0) then

				-- If the continent has only one country in it
				-- (Australia) then we can skip the pick-country
				-- step.
				if (#continents[continent].countries == 1) then
					country = continents[continent].countries[1]
					table.insert(state_stack, states.PICK_TIMEZONE)
				elseif (continent == "UTC") then
					timezone = "UTC"
					table.insert(state_stack, states.CONFIRM_TIMEZONE)
				else
					table.insert(state_stack, states.PICK_COUNTRY)
				end
			else
				table.remove(state_stack)
			end
		elseif (state == states.PICK_COUNTRY) then
			retcode, country = pickCountryDialog(continent, country)
			if (retcode == 0) then

				-- Like above, if the country has only one timezone
				-- we can skip picking it.
				if (#countries[country].tzs == 1) then
					timezone = countries[country].tzs[1].name
					table.insert(state_stack, states.CONFIRM_TIMEZONE)
				else
					table.insert(state_stack, states.PICK_TIMEZONE)
				end
			else
				table.remove(state_stack)
			end
		elseif (state == states.PICK_TIMEZONE) then
			retcode, timezone = pickTimezoneDialog(country, timezone)
			if (retcode == 0) then
				table.insert(state_stack, states.CONFIRM_TIMEZONE)
			else
				table.remove(state_stack)
			end
		elseif (state == states.CONFIRM_TIMEZONE) then
			retcode = confirmTimezoneDialog(timezone)
			if (retcode == 0) then
				final_timezone = timezone
				break
			else
				table.remove(state_stack)
			end
		end
		dialogClear()
	end

	dialogClear()
	endDialog()

	if (really_do_it) then
		os.execute("tzsetup " .. final_timezone)
	else
		print(final_timezone)
	end
end


main()
